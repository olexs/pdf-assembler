name: Claude Code - Renovate PR Check

on:
  workflow_run:
    workflows: ["Main CI"]
    types: [completed]

jobs:
  check-renovate-failure:
    # Only run if the workflow failed and the PR is from Renovate
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.head_repository.full_name == github.repository &&
      startsWith(github.event.workflow_run.head_branch, 'renovate/')

    runs-on: ubuntu-latest
    permissions:
      contents: write      # Allow Claude to push commits
      pull-requests: write # Allow Claude to comment on PRs
      issues: write        # Allow Claude to comment (PRs are issues in GitHub API)
      id-token: write
      actions: read        # Required for Claude to read CI results on PRs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Run Claude Code to analyze failure
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            The Renovate PR build failed for branch ${{ github.event.workflow_run.head_branch }}.
            Please analyze the CI failure and propose a fix if possible.

            Workflow run: ${{ github.event.workflow_run.html_url }}

          additional_permissions: |
            actions: read

          # Allow Claude to run build, package, lint, and test commands (excludes e2e tests)
          claude_args: >-
            --allowedTools "Bash(npm run lint:*)"
            --allowedTools "Bash(npm run test:*)"
            --allowedTools "Bash(npm run package:*)"
            --allowedTools "Bash(npm run make:*)"
            --allowedTools "Bash(npm test:*)"
            --allowedTools "Bash(npm ci:*)"
            --allowedTools "Bash(npm install:*)"
            --allowedTools "Bash(npm uninstall:*)"
            --allowedTools "WebFetch"